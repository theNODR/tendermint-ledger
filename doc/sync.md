# Как работает мультиледжер

Свой адрес формируется путем транзакции, в которой исходящим адресом является собственный адрес леджера, а входящим адресом текущий входящий или исходящий адрес.

Чужой адрес формируется путем транзакции, в которой исходящим адресом является любой несобственный адрес леджера, а входяшим адресом текущий входящий или исходящий адрес.

Статус входящего или исходящего адреса бывает:
* Свой адрес.
* Чужой адрес.

Поэтому транзакция относительно статуса участвующей в ней входящих и исходящих адресов бывает:
1. Оба адреса являются своими.
2. Исходящий адрес свой, входящий адрес чужой.
3. Исходящий адрес чужой, входящий адрес свой.
4. Оба адреса чужие.

## Открытие трансфер канала
Выполняемые проверки:
1. Проверка на ненулевой план передачи траффика.
2. Проверка на соответствие шаблону входящего адреса.
3. Проверка на соответствие шаблону исходящего адреса.
4. Проверка на наличие уже существующей транзакции в леджере.
5. Анализ статусов.
    1. Получение статуса входящего адреса.
    2. Получение статуса исходящего адреаса.
    3. Оба адреса чужие. Ошибка.
    4. Исходящий адрес чужой, входящий свой. С задержкой выполняется синхронизация со вторым леджером. После этого повторно выполянется проверка на наличие уже существующей транзакции в леджере.
    Если транзакция найдена - это успешное завершение, если не найдена - ошибка.
    6. Исходящий адрес свой, входящий чужой.
        1. Если транзакция открытия входящего адреса есть, то переходим к пункту 6, иначе - ошибка.
        2. Если транзакции открытия входящего адреса нет. Выполняем синхронизацию со вторым леджером. Если после синхронизации транзакция открытия найдена, то переходим к пункту 8, иначе ошибка.
    7. Если оба адреса свои, то переходим к пункту 6.
6. Сравнение цены еденицы траффика из текущей транзакции и максимально возможной цены еденицы траффика из транзакции открытия исходящего адреса и минимально возможной цены еденицы траффика из транзакции открытия входящего адреса.
7. Проверка на наличие свободных средств на исходящем адресе.

> В случае разных статусов входящего и исходящего адресов приоритетным является леджер, для которого своим адресом является исходящий адрес. Именно он записывает транзакцию в "блокчейн",
> а леджер для которого своим адресом является входящий адрес выполняет исключительно синхронизацию данных в "блокчейн".

## Закрытие трансфер канала
Выполняемые проверки:
1. Проверка на соответствие фактической цены траффика заявленной цене траффика. Допускается некоторое небольшое отклонение от заявленной цены.
2. Проверка на соответствие шаблону входящего адреса.
3. Проверка на соответствие шаблону исходящего адреса.
4. Проверка на наличие в леджере существующей транзакции открытия трансфер-канала.
5. Проверка на наличие в леджере существующей транзакции закрытия трансфер-канала.
6. Анализ статусов:
    1. Получение статуса входяшего адреса.
    2. Получение статуса исходящего адреса.
    3. Оба адреса чужие. Ошибка.
    4. Исходящий адрес свой, входящий адрес чужой.
    С задержкой выполняется синхронизация со вторым леджером. После этого повторно выполянется проверка на наличие уже существующей транзакции закрытия трансфер канала в леджере.
    Если транзакция найдена - это успешное завершение, если не найдена - ошибка.
    5. Если исходящий адрес чужой, входящий адрес свой.
        1. Если транзакция открытия исходящего канала найдена, то переходим к пункту 6.
        2. Если транзакция открытия исходящего канала не найдена, то завершение с ошибкой.
    6. Оба адраса свои. Переходим к пункту 7.
7. Сравнение цены еденицы траффика из текущей транзакции и максимально возможной цены еденицы траффика из транзакции открытия исходящего адреса и минимально возможной цены еденицы траффика из транзакции открытия входящего адреса.
 
> В случае разных статусов входящего и исходящего адресов приоритетным является леджер, для которого своим адресом является входящий адрес. Именно он записывает транзакцию в "блокчейн",
> а леджер для которого своим адресом является исходящий адрес выполняет исключительно синхронизацию данных в "блокчейн".
