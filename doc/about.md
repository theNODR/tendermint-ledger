# Взаимодействие в пиринговой сети

В файле описано взаимодействие между нодами пиринговой сети.

## Роли нод пиринговой сети
В пиринговой сети происходит обмен данными видеопотока между нодами пиринговой сети.
Выделим роли нод пиринговой сети, возникающие в результате обмена данными:
* Нода трекера кошелька.
* Раздающая нода.
* Принимающая нода.

### Нода трекера кошелька
Нода трекера кошелька - эта нода пиринговой сети, которая выполняет учет размера данных переданных, между раздающей нодой и принимающей нодой, и учет движения токенов, возникшего в результате передачи данных.

### Раздающая нода
Раздающая нода - это нода пиринговой сети, на которой расположены данные видеопотока, запращиваемые принимающей нодой.

### Принимающая нода
Принипающая нода - это нода пиринговой сети, которая запращивает данные видеопотока с целью их воспроизведения, и для которой подтверждено разрещение на просмотр данных видеопотока.

## Взаимодействие в приринговой сети между нодами по ролям

В разделе описано взамодействие в пиринговой сети между ролями:
* нода трекера кошелька &ndash; раздающая нода;
* нода трекера кошелька &ndash; принимающая нода.

> Необходимо дополнить:
> * Взаимодействие принимающая нода &ndash; раздающая нода.
> * Описание предполагает один общий трекер для раздающей и принимающей ноды. 

### Принятые обозначения

#### Ноды
Ноды обозначаются следующим образом:
* Нода трекера кошелька &ndash; T
* Раздающая нода &ndash; B
* Принимающая нода &ndash; C

### Публичный и приватный ключ
Каждая нода имеет собственный публичный и приватный ключ
Публичные ключи для нод обозначаются:
* T &ndash; PK<sub>T</sub>
* B &ndash; PK<sub>B</sub>
* C &ndash; PK<sub>C</sub>

Приватные ключи для нод обозначаются:
* T &ndash; SK<sub>T</sub>
* B &ndash; SK<sub>B</sub>
* C &ndash; SK<sub>C</sub>

#### Адреса
Каждая нода имеет собственный адрес, который используется для обычного перевода токенов между нодами в блокчеин-сети.
Адрес вычисляется как ```A = SHA256.SHA224(PK)```.
Адреса для нод обозначаются:
* T &ndash; A<sub>T</sub>
* B &ndash; A<sub>B</sub>
* C &ndash; A<sub>C</sub>

У трекера во владении находятся специальные адреса:
* входящий адрес раздающей ноды (входящий адрес);
* исходящий адрес принимающей ноды (исходящий адрес).

При передаче данных видеопотока между раздающей и принимающей нодами учет движения траффика и токенов происходит как учет транзакций между специальными адресами входящих и исходящих кошельков.
Соответсвенно, для передачи данных видеопотока необходима наличие входящего адреса у раздающей ноды, и исходящего адреса у принимающей ноды.
В общем случае, одна и таже нода может одновременно выполнять роль раздающей и принимающей ноды, поэтому у ней может быть одновремено входящий и исходящий адрес на трекере.
Адреса обозначаются:
* Входящий адрес раздающей ноды на ноде трекера кошелька T &ndash; <sup>I<sub>B</sub></sup>A<sub>T</sub>.
* Исходящий адрес принимающей ноды на ноде трекера кошелька T &ndash; <sup>S<sub>C</sub></sup>A<sub>T</sub>.

#### Огранизация передачи сообщений
Все сообщения в пиринговой сети подписываются секретным ключом ноды.
Текст сообщения должен содержать публичный ключ подписывающе ноды.
Этот публичный ключ должен совпадать с публичным ключом, переданным для проверки сигнатуры сообщения.

Сообщения в пиринговой сети бывают двух видов: сообщения запроса и сообщения ответа на запрос.
Сообщения ответа на запрос всегда подписываются единственной нодой, которая отвечает на входящий запрос.
Сообщения запроса всегда подписываются как минимум одной нодой, которая формирует запрос. В некоторых случаях возможна подпись одного сообщения несколькими нодами.

Если проверка сигнатуры сообщения приводит к отрицательному результату, такое сообщение сразу отбрасывается нодой, которая его получила. Никакие действия при этом получившая нода не выполняет, в ответ на поступивший запрос формируется ответ с HTTP-кодом 400. 

#### Взаимодействие нод
##### Подготовка раздающей ноды
1. Выполнение рукопожатия раздающей ноды B и ноды трекера кошелька T.
Результатом вызова является публичный ключ трекера PK<sub>T</sub>, который будет использоваться для проверки сообщений трекера.
Используется метод API handshake.
2. Получение входящего адреса <sup>I<sub>B</sub></sup>A<sub>T</sub>.
Для получения входящего адреса используется метод API getIncomeAddress.

##### Подготовка принимающей ноды
1. Выполнение рукопожатия принимающей нодой C и ноды трекера кошелька T.
2. Получение исходящего адреса <sup>S<sub>C</sub></sup>T<sub>T</sub>.
Для получения исходящего адреса используется метод API getSpendAddress.

##### Поиск принимающей нодой раздающей ноды
&mdash;

##### Открытие контракта между раздающей и принимающей нодами
1. Формирование контракта принимающей нодой.
2. Подпись контракта приватным ключом принимающей ноды.
3. Передача подписанного контракта раздающей ноде.
4. Проверка условий контракта раздающей нодой. Если условия контракта удовлетворяют раздающую ноду и у ней есть запрашиваемые данные видеопотока, то п.6. Иначе п.5.
5. Уведомления принимающей ноды о невозможности выполнения контракта. Далее, см. п. 8. 
6. Подпись контракта приватным ключом раздающей ноды.
7. Отправка подписанного контракта на ноду трекера кошелька. Для сообщения об открытии контракта используется метод API openContract.
8. Конец.

##### Передача данных между раздающей и принимающей нодами в рамках контракта
&mdash;

##### Закрытие контракта между раздающей и принимающей нодами
1. После получения каждой атомарной порции данных видеопотока (сегмента) принимающая нода формируют квитанцию.
Квитанция - это корректное сообщение о закрытии канала, содержащее отчет о всех полученных принимающей нодой сегментах.
2. Если квитанция получена, является корректной и не является завершающей (квитанция о передаче последнего запрощенного сегмента), раздающая нода начинает передачу следующего сегмента.
3. Если квитанция не получена или является некорректной, раздающая нода:
    * подписывает последнюю корректную квитанцию и отправляет её в сообщении о закрытии контракта на ноду трекера кошелька.
Для сообщения о закрытии контракта используется метод API closeContract;
    * прерывает передачу сегментов принимающей ноде.
4. Если квитанция получена, является корректной и при этом является квитанцией за последний запрощенный сегмент, раздающая нода подписывает её и отправляет сообщением о закрытии контракта.

##### Закрытие входящего адреса
1. Закрытие входящего адреса выполняется методом API closeIncomeAddress

##### Закрытие исходящего адреса
1. Закрытие входящего адреса выполняется методом API closeSpendAddress