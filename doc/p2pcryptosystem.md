# Прототип криптографиеской системы доставки контента в пиринговой сети
## Определения
**Пир** - Независимая единица, осуществляющая потребление и передачу контента в пиринговой сети. Каждый пир может быть соединен с другими пирами и осуществлять ретрансляцию контента в сети. В прототипе пиринговой сети, все пиры координируются одним централизованным `трекером`.  
**Трекер** - обособленная единица пиринговой сети, осуществляющая координацию общения `пиров`, принимает сообщения о `транзакциях` от приров, фиксирует результат транзакций в `леджере`. Для прототипа - трекер, это централизованный узел сети, выполняющий функции централлизованного координатора и хранилища данных транзакций пиринговой сети доставки контента.  
**Траффик** - полезный контент, передаваемый в пиринговой сети. Измеряется в байтах. Трафик передается в виде неделимых единиц - `сегментов`.  
**Сегмент** - неделимая единица контента, передаваемая в пиринговой сети. Размер сегмента в байтах не является постоянным.   
**Токен** - единица стоимости траффика. Используется для "оплаты" передачи трафика внутри пиринговой сети. Для прототипа - это внутренняя "криптовалюта" пиринговой сети. В прототипе сети, токенами владеет исключительно `трекер`, токены выполняют роль регулятора передачи траффика в сети.   
**Адрес** - специальный идентификатор внутри сети, с которым связан некоторый объем `токенов`. Передача токенов в сети осуществляется только между адресами. Созданием адресов, ведением их баланса, принадлежности пирам и перемещением средств между ними занимается `трекер`, на основании информации о `транзакциях`, полученных от пиров.   
**Транзакция** - информация о действии, происходящим внутри пиринговой сети. Транзакция может содержать информацию ос обытиях, произошедших в сети, а также информацию о перемещении `токенов` между адресами.   
**Канал** - состояние "договоренности" между двумя участниками пиринговой сети, в котором декларируется информация о возможных действиях, которые могут быть совершены в рамках канала. `Открытие канала` - создание нового канала, операция, "подвержденная" обеими сторонами. `Закрытие канала` - уничтожение канала и фиксация произошедших событий (и конечного состояния сети) за время открытия канала. Канал закрывается по согласию обеих сторон, либо принудительно, при наступлении определенных событий. Для прототипа сести существует два типа каналов - между пиром и трекером, между пиром и пиром.   
**Адрес трекера** - `адрес` для хранения исходного баланса `трекера`. Только трекер может осуществлять `транзакции` с этого адреса на другие адреса (обладает приватным ключом к этому адресу для подписи транзакций). В прототипе сети начальный баланс на адресе трекера назначается автоматически (берется из ниоткуда).   
**Адрес для оплаты траффика (spend address)** - `адрес`, назначаемый `трекером` для каждого `пира` в рамках `канала` между трекером и пиром. Данный адрес предназначен для "оплаты" приёма траффика от других пиров и может быть использован только как исходный адрес при открытии канала между пирами. При открытии канала на данный адресс выделяется фиксированная сумма которая фиксируется тарнзакцией открытия канала и сообщается пиру. Канал закрывается при исчерпании средств баланса и других событиях. При закрытии канала, оставшийся баланс на адресе переводится обратно на `адрес трекера`, а сам адрес для оплаты уничтожается.   
**Адрес для приема оплаты траффика (income address)** - `адрес`, назначаемый `трекером` для каждого `пира` в рамках `канала` между трекером и пиром. Данный адрес предназначен для приема оплаты за траффик, передаваемый другим пирам и может быть использован только как адрес назначения при открытии канала между прирами. При открытии канала баланс данного адреса равен 0. При закрытии каналов между пирами, на данный баланс поступают токены оплаты за передчау траффика. При закрытии канала между пиром и трекером, существующий на адресе баланс переводится на `адрес трекера`, а сам адрес для приема оплаты уничтожается.   
**Адрес канала передачи (transfer address)** - адрес, назначаемый пиром при открытии канала передачи. Адрес предназначен для резервирования средств для оплаты передачи траффика внутри канала. При открытии канала, на данный адрес переводится лимит канала. При закрытии канала, с данного адреса переводится оплата за фактически переданный объем данных передающему приру (на адрес приема оплаты) и остаток средств обратно получающему приру на адрес для оплаты траффика.
## Протокол
Протокол определяет правила общения между участниками в пиринговой сети. Минимальный пример достаточной сети, для описания протокола включает в себя три участника: Трекер (`Т`), пир А (`А`) и пир Б (`Б`). Для прототипа рассматривается одностороннее взаимодействия между пирами, где пир `А` получает траффик от пира `Б`, а пир `Б`, "получает" оплату за переданный траффик.   
Данный протокол определяет логическое взаимодействия и не накладывает ни каких условий и ограничений на реализацию протокола (реальный формат и структуру сообщений, передаваемые данные внутри сообщений, количество сообщений).
### Каналы оплаты/передачи
Все типы каналов в прототипе системы организуются одинаково. Канал существует с момента отправки в леджер `транзакции открытия канала` и до момента отправки в леджер `транзакции закрытия канала`, которая зафиксирует перемещение средств и новое состояние в системе. Во время работы канала, между участниками установившими канал, происходит обмен транзакциями обновления состояния канала. Каждая транзакция обновления состояния является `транзакцией закрытия канала`, но не отправляется в леджер, пока канал не исчерпал лимиты (учитывается лимит с обеих сторон канала).   
При открытии канала оба пира получают начальное состояние и подписанную с обеих сторон `транзакцию открытия канала` (которая отправляется в леджер для фиксации открытия канала), а также `транзакцию закрытия канала` в их исходном состоянии (с 0 балансом) - `0-ю транзакцию закрытия`. Такая транзакция может быть отправлена для "внештатного" закрытия канала любой из сторон (обрыв соединения, фрод, нарушение протокола). В случае канала пир - трекер - такую транзакцию сохраняет и сам трекер и использует ее для записи в леджер при внештатном закрытии канала. В случае пир - пир - оба пира сохраняют эту транзакцию у себя. При нормальном закрытии канала в леджер отправляется последняя транзакция с последним состоянием внутри канала.   
Все транзакции обновления состояния канала являются версиями транзакции закрытия, каждая новая транзакция является аналогом предыдущей, с обновленным состоянием (баланс, сумма траффика) и увеличенной версией, транзакция с большей версией отменяет любую предыдущую транзакцию (с таким же идентификатором и адресами), если предыдущая версия еще не попала в перманентное хранилище леджера.
### Каналы оплаты траффика (пир - трекер)
Первым этапом внутри протокола является подключение пира к трекеру и открытие каналов для оплаты и приема оплаты за траффик между пиром и трекером. Когда пир подключается к трекеру, он идентифицирует себя и запрашивает у трекера открытие каналов оплаты и приема оплаты. При успешном открытии каналов, трекер фиксирует открытие каналов соответствующими транзакциями и передает данные транзакций пиру (включая `0-е транзакции закрытия`, которые не выполняются в случае отсутствия нарушений протокола). Пир подписывает транзакции трекера своей подписью (обозначая таким образом согласие с предложением трекера) и возвращает их трекеру со своей подписью.   
Для открытия канала оплаты (spend) трекер генерирует адрес оплаты и осуществляет перевод фиксированной суммы на адрес оплаты со своего адреса, формируется 0-я транзакция закрытия канала с возвратом средств трекеру и таймлоком. Данные транзакций передаются пиру (чтобы ему был известен адрес оплаты, баланс и другие данные, необходимые для дальнейшего использования канала) и транзакция открытия записывается в леджер, 0-я транзакция сохраняется для внештатного закрытия канала.   
Для открытия канала приема оплаты (income) трекер генерирует адрес приема оплаты с 0 балансом. Открытие канала также фиксируется транзакцией. Данная транзакция не содержит перевода средств, а фиксирует условия использования канала (для прототипа - допустимый максимальный лимит на данном адресе, при достижении которого необходимо закрыть канал и вернуть средства трекеру), данные транзакции передаются пиру.   
В любой конкретный момент времени, между трекером и пиром может быть открыт только один канал оплаты и только один канал приема оплаты. Трекер должен контроллировать текущее состояние каналов для всех подключенных пиров.   
При закрытии каналов, пир может запрашивать открытие новых каналов. Закрытие каналов фиксируется соответствующими транзакциями закрытия. Транзакции должна включать в себя ссылки на соответствующии транзакции открытия.   
Пир не обязан открывать оба канала. Если какой-то из каналов не был открыт, пир не сможет принимать или отдавать траффик из пиринговой сети. Для прототипа сети, каналы могут открываться и закрываться независимо друг от друга.
### Каналы передачи траффика (пир - пир)
Для осуществления передачи траффика между пирами должен быть открыт канал передачи. Канал передачи открывается в рамках каналов оплаты (канала оплаты для получающего траффик пира и канала приема оплаты для отдающего траффик пира). При отсутствии валидных каналов оплаты, канал передачи не может быть открыт.   
Канал передачи открывается по договоренности пиров и фиксируется транзакцией средств на адрес канала передачи и 0-й транзакцией закрытия канала. Для открытия каналов пиры используют информацию, которой располагают на данный момент и только уведомляют трекер о том, что канал был открыт. Если проверки при открытии канала не были выполнены или каким-либо образом подделаны, транзакция открытия не будет принята трекером, однако, передача траффика может состоятся, но будет признана некорректной трекером. Пиры не ожидают подтверждения от трекера, т.к. в прототипе протокола подразумевается, что имеющейся информации достаточно для проверки и открытия корректного канала.   
Информация открытия канала передачи должна включать в себя корректные данные о транзакции открытия канала оплаты, данные о декларируемом лимите оплаты/объема траффика, который должен быть не больше текущего баланса в канале оплаты. Принимающий траффик пир А формирует начальные данные транзакций открытия и 0-й транзакции закрытия канала (данные платежного канала, данные о лимитах в канале передачи), подписывает их и отправляет как предложение открыть канал передачи отдающему пиру Б. Отдающий траффик пир Б, получив сообщения об открытии и 0-ю транзакцию закрытия, проверяет их, добавляет свои данные (информацию о платежном канале для приема оплаты), подписывает и отправляет как транзакции открытия/закрытия канала передачи трекеру и обратно пиру А. Пир А, получив корректные и подписанные данные транзакции считает канал передачи открытым.   
После открытия канала возможна передача траффика от пира Б к пиру А в виде сегментов, по запросам от пира А. Состояние канала, а также принудительное или "естественное" закрытие канала, передачи внутри канала контроллируются пирами, трекер не принимает участия.   
Каждая передача сегмента данных внутри канала формирует транзакцию закрытия канала с текущим состоянием, которую подписывают оба пира. Данная транзакция не отправляется в леджер, если ни один из пиров не собирается закрывать канал. Оба пира сохраняют последнюю подписанную транзацию закрытия. Транзакция включает информацию о переданном траффике внутри канала (идентификаторы сегментов, объем информации, объем средств), а также перевод средств с адреса канала на адрес приема оплаты (пиру Б) за фактический траффик и оставшиеся средства на адрес оплаты (пиру А).   
При истечении лимитов в канале передачи или других событиях, последняя транзакция закрытия канала передачи отправляется в леджер. При нормальном закрытии канала, транзакцию закрытия формирует пир А и отправляет на трекер и другому пиру, как уведомление о закрытии канала (помечает для пира Б транзакцию как последнюю). Также, если пир Б приходит к сосоянию невозможности отдавать больше траффика, он помечает транзакцию со своей стороны как последнюю, уведомляя тем самым пир А о закрытии канала.   
> TODO: протокол передачи сегментов. Должен включать в себя гарантию оплаты и передачи траффика на текущем состоянии канала. В случае разрыва/нарушения протокола, транзакция с последним состоянием отправляется, как транзакция закрытия канала. Трекер, в случае обрыва обоих пиров, транзакцию закрытия канала не получит и выполнит 0-ю транзакцию закрытия канала, соответственно, состояние балансов адресов не изменится. Протокол должен обеспечить "заинтересованность" пиров в передаче траффика и оплаты этой передачи.   

После закрытия канала передачи, для осуществления дальнейшей передачи трафика, необходимо открыть новый канал. Если текущие платежные каналы не позволяют открыть новый канал передачи, они закрываются, и открываются новые каналы.
## Структура транзакций
Любые транзакции внутри прототипа пиринговой сети определяются общей структурой. Данная структура не определяет формат передачи и количество сообщений, необходимых для передачи данных транзакции или нескольких транзакций. Для транзакций определена следующая структура:   
**timestamp** - время транзакции.   
**timelock** - время выполнения транзакции.   
**txid** - идентификатор транзакции, уникальное число (возможно, зависимое от данных транзакции) однозначно идентифицирующее транзакцию. Способ получения числа должен гарантировать уникальность.   
**version** - версия транзакции.   
**type** - тип транзакции, определены следующие типы: `open spend`, `close spend`, `open income`, `close income`, `open transfer`, `close transfer`.   
**parenttxid** - идентификатор родительской транзакции, определяет идентификатор существующей транзакции, на основании которой производится данная транзакция. Идентификатор используется для связи транзакций, работающих в рамках каналов. Значение может отсутствовать.   
**from** - исходный адрес, с которого перемещаются токены.   
**to** - адрес назначения, куда перемещаются токены.   
**amount** - количество токенов (может быть 0 или * - все токены с баланса адреса).   
**public key** - публичный ключ источника транзакции.   
**data** - дополнительные данные транзакции, структура зависит от типа транзакции.   
**signatures** - подписи транзакции.   
### Данные транзакции открытия канала оплаты
Транзакция открытия канала оплаты является транзакцией перевода средств с адреса трекера на адрес оплаты, созданный для пира. Кроме суммы, транзакция открытия содержит следующие дополнительные данные:   
**Количество траффика** - допустимое количество траффика, соответствующее сумме оплаты, назначаемое трекером;   
**Публичный ключ пира** - публичный ключ пира, которому разрешено использовать средства с данного адреса.
### Данные транзакции закрытия канала оплаты
Транзакция закрытия канала оплаты является транзакцией перевода оставшихся средств с адреса пира (созданного при открытии) обратно на адрес трекера. Также, транзакция содержит дополнительные данные об актуальном количестве траффика, переданного пока канал был открыт.
### Данные транзакции открытия канала приема оплаты
Транзакция открытия канала приема оплаты не переводит средства. Транзакция декларирует объем траффика, который может быть принят, а также публичный ключ принимающего пира. В процессе открытия канала формируется также 0-я транзакция закрытия, которая возвращает весь остаток средств с адреса приема обратно на адрес трекера.   
**Количество траффика** - допустимое количество траффика, соответствующее сумме оплаты, назначаемое трекером;   
**Публичный ключ пира** - публичный ключ пира, которому разрешено получать средства на данный адрес.
### Данные транзакции закрытия канала приема оплаты
Транзакция закрытия канала приема оплаты является транзакцией перевода полученых средств с адреса пира (созданного при открытии) на адрес трекера. Также, транзакция содержит дополнительные данные об актуальном количестве траффика, переданного пока канал был открыт.
### Данные транзакции открытия канала передачи
Транзакция открытия канала передачи является транзакцией перевода средств с адреса оплаты на адрес канала передачи. Транзакция содержит следующие данные:   
**Количество траффика** - допустимое количество траффика, соответствующее сумме оплаты, назначается пиром.   
**Публичный ключ передающего пира** - публичный ключ пира, с которым открывается канал и который будет получать оплату за переданный траффик.
### Данные транзакции закрытия канала передачи
Транзакция закрытия канала передачи является транзакцией перевода средств с адреса канала оплаты на следующие адреса:   
**Адрес отдающего пира** - переводится сумма за фактический траффик;   
**Адрес принимающего пира** - обратная транзакция остатка средств принимающему пиру (разница между суммой при открытии канала и фактической оплатой).   
Транзакция закрытия также влкючает в качестве дополнительных данных список идентификаторов переданных сегментов.
## Данные для постоянного сохранения (прототип леджера)
В постоянное хранилище помещаются все валидные проведенные транзакции. Данные должны включать в себя всю необходимую информацию о транзакции, включая все дополнительные данные и подписи. Неактуальные для конкретного типа транзакции поля остаются пустыми.
## Логика трекера (включая прототип леджера)
Трекер обеспечивает прием и валидацию транзакций, хранит текущее состояние системы (подключенные пиры, балансы, транзакции). Задача трекера установить коммуникацию с пиром и обработать транзакции от пира. Транзакции открытия каналов оплаты сопровождаются созданием соответствующих адресов для пиров. Трекер должен хранить текущие открытые каналы с каждым пиром и следить за их состоянием. Первая версия прототипа подразумевает, что пиринговая сеть состоит только из доверенных пиров, которые всегда соблюдают протокол.
Все транзакции изначально попадают в пул неподтвержденных транзакций. Транзакции считаются подтвержденными, если выполняются все условия проведения транзакции.   
> Проведение транзакции возможно согласно установленному значению в поле `timelock`. Все неподтвержденные транзакции, а также транзакции, которые инвалидируются новыми версиями транзакций удаляются из пула и не записываются в постоянное хранилище.   

**Общие условия проведения транзакции**   
Для проведения транзакции должны быть выполнены общие проверки:   
* Транзакция использует валидные адреса
* Транзакция не приводит к отрицательным балансам
* Транзакция корректно подписана
* Транзакция подписана разрешенными участниками и совершается между разрешенными адресами для данного типа транзакции.   
**Условия проведения транзакции открытия платежных каналов**   
* На адресе трекера достаточно средств   
**Условия проведения транзакции закрытия платежных каналов**   
* Имеется соответствующий открытый канал
* Соблюдается баланс в канале   
**Условия проведения транзакции открытия каналов передачи**   
* Имеется открытый платежный канал для принимающего пира
* На балансе платежного канала достаточно средств
* Имеется открытый платежный канал для отдающего пира и его лимит траффика не исчерпан
* Отсутствует открытый канал передачи между данной парой пиров   
**Условия проведения транзакции закрытия каналов передачи**   
* Имеется открытый канал передачи между данной парой пиров
* Соблюдается баланс в канале   
При инициализации, трекер генерирует свою пару ключей для подписи сообщений, создает необходимые данные для генерации адресов, генерирует адрес для собственного баланса. Для прототипа системы, трекер сам себе выписывает баланс на свой адрес (если он еще не был создан). При старте на терекере не должно быть открытых каналов и зарегистрированных пиров.   
Все полученные транзакции, добавляются в пул непроведенных транзакций. Трекер производит проверку, и на основании валидных транзакций формирует неперманетное внутреннее состояние - текущие балансы, открытые каналы (связанные с пирами и парами пиров), идентификацию подключенных пиров. Данное состояние позволяет трекеру быстро совершать проверки балансов, открытие и закрытие каналов. Все валидные транзакции, также помещаются в постоянное хранилище.
## Логика пира
Основная задача пира - соединение с другими пирами, открытие каналов передачи и передача траффика. Для открытия канала передачи пир должен запросить у трекера открытие соответствующих каналов оплаты и приема оплаты. Задача пира состоит в поддержании "баланса" открытых каналов, как с трекером, так и с другими пирами.   
Любой из каналов оплаты с трекером должен быть открыт и переоткрываться при достижении лимитов в канале, т.о. задача пира сводится к поддержке постоянно открытых каналов оплаты. Выполнение данного условия позволяет открывать каналы передачи в любой момент времени.   
Канал передачи открывается всегда в рамках открытых каналов оплаты. Канал передачи должен быть открыт только тогда, когда пир с определенной долей вероятности уверен, что пир, с которым открывается канал передачи будет готов отправить нужный траффик в максимально короткий срок. При достижении лимитов в каналах оплаты, все зависимые каналы передачи должны быть закрыты с текущим балансом и каналы оплаты должны быть переоткрыты.